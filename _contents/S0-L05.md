---
layout: post
title: Survey  human alignment 
lecture: 
lectureVersion: current
extraContent: 
notes: team-3
video: team-5
tags:
- Alignment
---

In this session, our readings cover: 

## Required Readings: 

### Aligning Large Language Models with Human: A Survey
+ https://arxiv.org/abs/2307.12966
+  https://huggingface.co/blog/the_n_implementation_details_of_rlhf_with_ppo 
+ https://huggingface.co/blog/stackllama


## More readings 

### Github Awesome-RLHF
+ [https://github.com/opendilab/awesome-RLHF/tree/main?tab=readme-ov-file#2024](https://github.com/opendilab/awesome-RLHF/tree/main?tab=readme-ov-file#2024)


### The Flan Collection: Designing Data and Methods for Effective Instruction Tuning
+ https://arxiv.org/abs/2301.13688
+ We study the design decisions of publicly available instruction tuning methods, and break down the development of Flan 2022 (Chung et al., 2022). Through careful ablation studies on the Flan Collection of tasks and methods, we tease apart the effect of design decisions which enable Flan-T5 to outperform prior work by 3-17%+ across evaluation settings. We find task balancing and enrichment techniques are overlooked but critical to effective instruction tuning, and in particular, training with mixed prompt settings (zero-shot, few-shot, and chain-of-thought) actually yields stronger (2%+) performance in all settings. In further experiments, we show Flan-T5 requires less finetuning to converge higher and faster than T5 on single downstream tasks, motivating instruction-tuned models as more computationally-efficient starting checkpoints for new tasks. Finally, to accelerate research on instruction tuning, we make the Flan 2022 collection of datasets, templates, and methods publicly available at this https URL.

### DPO Direct Preference Optimization: Your Language Model is Secretly a Reward Model
+ https://arxiv.org/abs/2305.18290
+ https://huggingface.co/blog/dpo-trl 
+ While large-scale unsupervised language models (LMs) learn broad world knowledge and some reasoning skills, achieving precise control of their behavior is difficult due to the completely unsupervised nature of their training. Existing methods for gaining such steerability collect human labels of the relative quality of model generations and fine-tune the unsupervised LM to align with these preferences, often with reinforcement learning from human feedback (RLHF). However, RLHF is a complex and often unstable procedure, first fitting a reward model that reflects the human preferences, and then fine-tuning the large unsupervised LM using reinforcement learning to maximize this estimated reward without drifting too far from the original model. In this paper we introduce a new parameterization of the reward model in RLHF that enables extraction of the corresponding optimal policy in closed form, allowing us to solve the standard RLHF problem with only a simple classification loss. The resulting algorithm, which we call Direct Preference Optimization (DPO), is stable, performant, and computationally lightweight, eliminating the need for sampling from the LM during fine-tuning or performing significant hyperparameter tuning. Our experiments show that DPO can fine-tune LMs to align with human preferences as well as or better than existing methods. Notably, fine-tuning with DPO exceeds PPO-based RLHF in ability to control sentiment of generations, and matches or improves response quality in summarization and single-turn dialogue while being substantially simpler to implement and train.


### Training language models to follow instructions with human feedback 
   + https://arxiv.org/abs/2203.02155) 
   +  "further fine-tune this supervised model using reinforcement learning from human feedback. We call the resulting models InstructGPT." 

###  Deep reinforcement learning from human preferences 
+ https://openreview.net/forum?id=GisHNaleWiA
+  "explore goals defined in terms of (non-expert) human preferences between pairs of trajectory segments. We show that this approach can effectively solve complex RL tasks without access to the reward function" |


## Aligning Language Models with Human Preferences

### Human Alignment in LLM

#### What is Human Alignment in LLM?
<img src="{{ site.baseurl }}/Lectures/S0-L05/intro1.png" width="80%" height="80%">

A LLM with proper alignment should not produce false information(hallucination), should not provide harmful 
or dangerous information, and should not provide useless content. 

Examples are on the right side show that some dishonest, harmful and useless contents are generated by the LLM
when given the prompts, thus it can be said that the LLM is not properly aligned with human values.

#### Components Needed for Successful Human Alignment
<img src="{{ site.baseurl }}/Lectures/S0-L05/intro2.png" width="80%" height="80%">

There are three components needed for successful human alignment, high quality data that embodies human needs and 
expectations, effective methods that can align models with human values either through training or fine tuning,
and proper benchmarks that are designed with human alignment in mind.

### Alignment Data Collection Methods

#### What is High Quality Data?
<img src="{{ site.baseurl }}/Lectures/S0-L05/data1.png" width="80%" height="80%">

High quality traning data should reflect human needs and expectation. 

The training data or in this context the instruction can be conceptualized as a pair of instruction input 
and corresponding response.

#### Collection Methods
<img src="{{ site.baseurl }}/Lectures/S0-L05/data1.png" width="80%" height="80%">

There are three main methods to collect data, the first one is using instruction from human, consisting of
pre-exiting human-annotated NLP benchmark and hand-crafted instruction. For the pre-existing human-annotated NLP
it can include tasks such as dialogue, reasoning and coding. The hand-crafted instructions are more close to actual 
conversations and there are a variety of dataset, include Databricks crowdsourced dataset, OpenAssistant, a dataset 
of over 10,000 dialogues and ShareGPT another crowdsourced dataset.

The second method is to collect synthetic instruction from strong LLMs either can be single-turn self-instruction, using ChatGPT to 
generate instructions following by a quality control filtering, or multi-turn instructions, by having LLM evaluate multiple dialogues from
user and generate instructions, it is better suited for real-world conversation tasks.

The third method is geared towards multilingual instruction, there are two methods, a, post-answering, where the instruction
is translated into the target language before prompting the LLM, and b, post-translating, where the LLM has English input 
and output English, but the pair is translated into the target language.

#### Data Collection Tool: PromptSource
"PromptSource is a toolkit for creating, sharing and using natural language prompts."
To compose contribute to dataset, the users can take the following three steps:

First step: Browse,
<img src="{{ site.baseurl }}/Lectures/S0-L05/PS1.png" width="80%" height="80%">

User can browse the examples from the Hugging Face Datasets as well as the labels.

Second step: Create,
<img src="{{ site.baseurl }}/Lectures/S0-L05/PS2.png" width="80%" height="80%">

User can use a Web-based GUI to write and view the newly created prompts, and user can utilize the sourcing mode and 
prompted dataset viewer mode respectively.

Third step: Check metrics,
<img src="{{ site.baseurl }}/Lectures/S0-L05/PS3.png" width="80%" height="80%">

User can view the high-level metrics with the helicopter view mode and to see the composition of the current collection, 
which the tool calls P3(Public Pool of Prompts).

#### Dataset Examples

##### Databricks Crowdsourced Dataset
The dataset is collected from 5000 employees, across 7 specific tasks, Open Q&A, Closed Q&A, Extract information from Wikipedia, 
Summarize information from Wikipedia, Brainstorming, Classification and Creative writing. Top labelers are rewarded.

Some examples of the dataset are:
<img src="{{ site.baseurl }}/Lectures/S0-L05/ex1.png" width="80%" height="80%">

<img src="{{ site.baseurl }}/Lectures/S0-L05/ex2.png" width="80%" height="80%">


##### Self-instruct Dataset (Single-turn)
<img src="{{ site.baseurl }}/Lectures/S0-L05/ex3.png" width="80%" height="80%">

The figure is an overview of the self-instruct dataset generation process based on GPT3,
the process start with initial seed set of tasks, then some tasks are sampled from the pool, the prompt is then fed to a 
"off the shelf" LLM, such as GPT3 and it will generate new instructions and instances, the generated data will be filtered for
low-quality or similar generation, and added to the pool.

However, the quantity and diversity of the generated data is not guaranteed.

A way to improve the data quality is by using chain-of-thought, where a reasoning process will be provoked.

<img src="{{ site.baseurl }}/Lectures/S0-L05/ex4.png" width="80%" height="80%">

The figure is an example of a chain-of-thought prompt, where the LLM is generating intermediate reasoning steps but
not just the final output.

##### Self-instruct Dataset (Multi-turn)

<img src="{{ site.baseurl }}/Lectures/S0-L05/ex5.png" width="80%" height="80%">

The paper Baize introduces a pipeline which uses ChatGPT to simulate user and agent conversation in the setting of 
multi-turn dialogues. The pipeline is shown in the bottom and the right figure shows self-distillation with feedback(SDF),
a potential alternative to RLHF(Reinforcement Learning with Human Feedback).

The authors use Quora and Stack Overflow as seeds and use ChatGPT to both ask question and generate responses, thus the 
generated data is multi-turn dialogues. 

To train Baize, the authors used SDF, whose output will also be ranked by ChatGPT and fine tuned based on the ranking.
SDF is three times faster than RLHF and does not need an additional model to assign the rewards.


##### Multilingual Instruction Dataset

<img src="{{ site.baseurl }}/Lectures/S0-L05/multi1.png" width="80%" height="80%">

BayLing is an "instruction following LLM" built upon LLaMA and it is designed to be able to construct translation
instruction paris for tuning automatically. It can achieve a 89% performance comparing to GPT-3.5-turbo with only
13 billion parameters.

<img src="{{ site.baseurl }}/Lectures/S0-L05/multi2.png" width="80%" height="80%">

This is an example of how the user can use BayLing to translate a sentence in multiple turns and mold the translation
to the user's preference.

### Data Management -- Post Data Collection 

Now that the data is generated, the questions raise: how much data is the optimal amount? Is it feasible integrate different
instructions together? How to control the quality of the data?

#### The dataset can be integrated 
<img src="{{ site.baseurl }}/Lectures/S0-L05/ans1.png" width="80%" height="80%">

Paper "How Far Can Camels Go? Exploring the State of Instruction Tuning on Open Resources" gives the answer that
the dataset can be integrated, the authors evaluated LLaMa 1B on different dataset and it shows that there is not a 
universal dataset that is the best tuning dataset but a mixed dataset can improve the overall performance of the
LM across different tasks.

#### The dataset quatity is more important than the quality

<img src="{{ site.baseurl }}/Lectures/S0-L05/ans1.png" width="80%" height="80%">

The paper "Alpagasus: Training a better Alpaca wit fewer data" answers the question that the dataset quantity is more
important than quality and the more isn't always the better. The authors trained the Alpagasus on 9k high quality data 
selected on the original 52k dataset and the performance of the model is better than the original model as evaluated by 
GPT-4

### Alignment Training 

<img src="{{ site.baseurl }}/Lectures/S0-L05/SFT1.png" width="80%" height="80%">

One training method is to use supervised fine-tuning, where the loss is calculated as the cross-entropy over the ground
truth.

<img src="{{ site.baseurl }}/Lectures/S0-L05/SFT2.png" width="80%" height="80%">

To align the model with human, there are three methods, one is online human preference training, where the model is 
trained in real time continuously, the second is offline human preference training, where the model is trained in a later
cycle after the feedback has been collected, and the third is parameter-effective fine-tuning, where the model is fine-tuned 
mainly through twerking the parameters.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT1.png" width="80%" height="80%">
In online reinforcement learning, the agent interacts directly with the environment and collects data through its own experience. This involves exploration by the agent, deciding which actions are expensive/risky, and adapting to changing situations and distributions.

In offline reinforcement learning, the agent learns from a fixed dataset. This is a faster and safer method of training, and it relies on the coverage of the dataset.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT2.png" width="80%" height="80%">
RLHF attempts to learn human preference signals from external reward models.
It involves three steps:
* Collect demonstration data and train a supervised policy
* Collect comparison data and train a reward model
* Optimize a policy against the reward model using the PPO reinforcement learning algorithm

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT3.png" width="80%" height="80%">
RAFT (Reward rAnked Fine Tuning) is a pipeline method that uses an existing reward model to select the best set of training samples based on the model outputs.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT4.png" width="80%" height="80%">
Many hyper-parameters must be tuned to achieve better stability and performance during the training procedure.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT5.png" width="80%" height="80%">
Direct Preference Optimization (DPO) and Preference Ranking Optimization (PRO) are two ranking-based approaches to offline human preference training.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT6.png" width="80%" height="80%">
In addition to DPO and PRO, using an SFT training objective and KL divergence as the regularization term as well as RRHF are two more examples of ranking-based approaches to learning human preferences in an offline fashion.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT7.png" width="80%" height="80%">
In addition to ranking-based approaches, there are also language-based approaches to learning human preferences. In concept behavior cloning, LLMS are trained on high and low quality datasets to distinguish between high and low quality instruction responses. In Chain of Hindsight, human preferences are incorporated as a pair of parallel responses discriminated as low-quality or high-quality using natural language profiles. 

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT8.png" width="80%" height="80%">
This figure shows a visualization of the Chain of Hindsight (CoH) process. CoH training loss is only applied on model output tokens.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT9.png" width="80%" height="80%">
A benefit of parameter-effective training (PET) is that LLMs could enable models to adhere to provided instructions. A downside is that vast GPU and extensive datasets are required for instruction training.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT10.png" width="80%" height="80%">
For supplementary parameters in PET, trainable tokens can be prepended to each hidden layer's input, leaving the parameters of the LLM frozen during fine-tuning.
With shadow parameters, one trains the weight representing model variance without modifying the number of total model parameters during inference.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AT11.png" width="80%" height="80%">
Underfitting issue: LLMs with LoRA (see previous slide) perform worse than fully fine-tuned ones, and it is preferable to use larger LLMs than larger training instruction datasets with LoRA.


### Alignment Evaluation
<img src="{{ site.baseurl }}/Lectures/S0-L05/AE1.png" width="80%" height="80%">
We will consider two main components of evaluation for alignment quality: Evaluation Benchmarks (AE1) and Evaluation Paradigm (AE2)

<img src="{{ site.baseurl }}/Lectures/S0-L05/AE2.png" width="80%" height="80%">
Closed-set benchmarks evaluate the skills and knowledge of aligned LLMs. Some general knowledge examples include MMLU and KoLA. 

<img src="{{ site.baseurl }}/Lectures/S0-L05/AE3.png" width="80%" height="80%">
For reasoning benchmarks, various benchmarks exist for different categories, including Arithmetic, Common Sense, and Big Bench, which tests for data understanding, word sorting, and causal judgement. Benchmarks also exist for codign abilities of LLMs

<img src="{{ site.baseurl }}/Lectures/S0-L05/AE4.png" width="80%" height="80%">
In addition to closed-set benchmarks, open-set benchmarks also exist, which can have more flexible and diverse responses. 

<img src="{{ site.baseurl }}/Lectures/S0-L05/AE5.png" width="80%" height="80%">
Human-based evaluation is an important alignment evaluation paradigm. In this paradigm, human annotators categorize each response into one of four levels. This depends highly on the subjectivity of the annotators, however.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AE6.png" width="80%" height="80%">
Using human-based evaluations can be inefficient and expensive. Some recent studies are trying to incorporate LLMs into output text classification for various NLP tasks. 
LLMs can also have evaluation bias, favoring their own responses or candidates that appear earlier. 

### Challenges and Future Directions
<img src="{{ site.baseurl }}/Lectures/S0-L05/AP2.png" width="80%" height="80%">
This chart shows that most of the LLMs reviewed are based on LLM technology, with FLAN arising as a common benchmark.

<img src="{{ site.baseurl }}/Lectures/S0-L05/AP3.png" width="80%" height="80%">
FLAN is short for Fine-tuned LAnguage Net. It is an instruction tuning approach to fine-tune language models on a collection of datasets described via instructions. 

<img src="{{ site.baseurl }}/Lectures/S0-L05/AP4.png" width="80%" height="80%">
This slide shows various comparisons and attributes of FLAN. Notably, instruction tuning with FLAN is only beneficial for models of a certain size, as seen on the bottom right graph. 